Description: Vote Processor
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  Stage:
    Type: String
    Default: dev
    Description: Name of the stage
  tablename:
    Type: String
    Default: tpm-2394
    Description: Name of the Dynamo DB Table

Globals:
  Function:
    Runtime: nodejs14.x
    Tracing: Active

Resources:
  IAMLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
      Policies:
        - PolicyName: allowLambdaLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
              - logs:*
              Resource: arn:aws:logs:*:*:*
        - PolicyName: allowDynamoDB
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
            - Effect: Allow
              Action:
                - dynamodb:*
              Resource:
                - arn:aws:dynamodb:us-east-1:162174280605:table/tpm-2394
  VoteLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: VoteLambda-tpmspec2449
      PackageType: Zip
      Runtime: nodejs14.x
      CodeUri: ./build/
      Handler: vote.handler
      Role: !GetAtt 
        - IAMLambdaRole
        - Arn
      Events:
        APIEvent:
          Type: HttpApi 
          Properties:
            Path: /vote
            Method: post
      Environment:
        Variables:
          VOTING_RESULT_TABLE: !Ref tpm-2394
  StreamLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: StreamLambda-tpmspec2449
      PackageType: Zip
      Runtime: nodejs14.x
      CodeUri: ./build/
      Handler: stream.handler
      Role: !GetAtt 
        - IAMLambdaRole
        - Arn
      Events:
        StreamEvent:
          Type: DynamoDB 
          Properties:
            Stream: arn:aws:dynamodb:us-east-1:123456789012:table/TestTable/stream/2016-08-11T21:21:33.291
            StartingPosition: LATEST
            FilterCriteria: 
              Filters:
                Pattern: "type": [ "vote" ]  
      Environment:
        Variables:
          VOTING_RESULT_TABLE: !Ref tablename

Outputs:
  Stack:
    Description: CloudFormation Stack URL
    Value: !Sub "https://console.aws.amazon.com/cloudformation/home?region=${AWS::Region}#/stacks/resources?stackId=${AWS::StackId}&filteringStatus=active&filteringText=&viewNested=true&hideStacks=false"